log connection

table <bliptown> { 127.0.0.1 }
table <bliptown-staging> { 127.0.0.1 }
table <monit> { 127.0.0.1 }

http protocol http_tls {
	match request header append "X-Forwarded-For" value "$REMOTE_ADDR"
	match request header append "X-Forwarded-By" value "$SERVER_ADDR:$SERVER_PORT"

	tls ciphers HIGH
	tls keypair "blip.town"
	tls keypair "bliptown-staging.com"
	include "/etc/relayd-keypairs.conf"

	match request url log
	match request header log "Host"
	match request header log "Referer"
	match request header log "User-Agent"
	match response header log "Content-Type"
	match response header log "Content-Length"

	pass request quick header "Host" value "monit.blip.town" forward to <monit>
	pass request quick header "Host" value "bliptown-staging.com" forward to <bliptown-staging>
	pass request quick header "Host" value "*.bliptown-staging.com" forward to <bliptown-staging>
	pass forward to <bliptown>
}

relay ipv4_bliptown {
	listen on 91.98.65.46 port 443 tls protocol http_tls
	forward to <monit> port 2812
	forward to <bliptown> port 8080
	forward to <bliptown-staging> port 8081
}

relay ipv6_bliptown {
	listen on 2a01:4f8:1c1a:8cdb::f port 443 tls protocol http_tls
	forward to <monit> port 2812
	forward to <bliptown> port 8080
	forward to <bliptown-staging> port 8081
}
